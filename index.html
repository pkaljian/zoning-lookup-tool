<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://js.arcgis.com/4.30/@arcgis/core/assets/esri/themes/light/main.css">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoning Lookup Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        } 
 
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .query-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .query-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .query-form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .query-text {
            font-size: 1.1em;
            color: #34495e;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .results {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid #ecf0f1;
            min-height: 100px;
        }

        .results h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-item {
            background: #f1f2f6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
        }

        .result-item.conditional {
            border-left-color: #f39c12;
        }

        .result-item.not-permitted {
            border-left-color: #e74c3c;
        }

        .result-item.accessory {
            border-left-color: #9b59b6;
        }

        .zone-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .permission-detail {
            margin-top: 5px;
            color: #555;
            font-size: 0.95em;
        }
.results .section-header {
  display: inline-block;
  margin-top: 20px;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
}
.results .section-header.permitted   { background: #eaf7ee; color: #1e7e34; }  /* green */
.results .section-header.conditional { background: #fff3e0; color: #b05600; }  /* orange */
.results .section-header.accessory   { background: #f3e9fb; color: #6f42c1; }  /* purple */

        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .no-results {
            text-align: center;
            color: #e74c3c;
            font-style: italic;
        }

           .definition-banner {
  background: #fffbe7;
  border: 1px solid #ffd75a;
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 10px;
  line-height: 1.4;
}
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .query-form {
                flex-direction: column;
                align-items: stretch;
            }

            select {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
<script src="ZoningData_not_permitted.js"></script>
      <script src="UseDefinitions.js"></script>
  
</head>
<body>
    <div class="container">
        <h1>Zoning Lookup Tool</h1>
        <p class="subtitle">Find zoning permissions for land uses quickly and easily</p>
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 30px; border-left: 5px solid #fdcb6e;">
            <strong>‚ö†Ô∏è Important Disclaimer:</strong> This tool provides general zoning information for reference purposes only. Always verify requirements with the Planning Department before making final development decisions. Zoning regulations may have additional requirements, recent updates, or site-specific considerations not reflected in this tool.
            <br><br>
            <strong>üìã Additional Resources:</strong>
            <a href="https://cityofpetaluma.org/zoning-map/" target="_blank" style="color: #2980b9; text-decoration: none;">View Official Zoning Map</a> | 
            <a href="https://petaluma.municipal.codes/SmartCode/2" target="_blank" style="color: #2980b9; text-decoration: none;">View Smart Code and Zoning Code</a>
        </div>

        <div class="query-section">
            <div class="query-title">Where can I put a specific use?</div>
            <div class="query-form">
                <span class="query-text">Where can I put a</span>
                <select id="landUseSelect">
                    <option value="">Select a land use...</option>
                </select>
                <span class="query-text">?</span>
               
            </div>
        </div>
<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-top: 15px; font-size: 0.9em; color: #6c757d;">
    Need help understanding a land use? <a href="https://petaluma.municipal.codes/ZoningOrds/28" target="_blank" style="color: #2980b9; text-decoration: none;">Find land use definitions here</a>
</div>
<div style="text-align: center; font-size: 1.2em; color: #7f8c8d; margin: 20px 0;">
    ‚Äî OR ‚Äî
</div>
        <div class="query-section">
            <div class="query-title">What's allowed in a specific zone?</div>
            <div class="query-form">
                <span class="query-text">What's allowed in</span>
                <select id="zoneSelect">
                    <option value="">Select a zone...</option>
                </select>
                <span class="query-text">zoning?</span>
               
            </div>
        </div>
<div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-top: 15px; font-size: 0.9em; color: #6c757d;">
    Properties in PUD/PCD zones may have additional requirements. <a href="https://cityofpetaluma.org/pud-and-pcd-guidelines/" target="_blank" style="color: #2980b9; text-decoration: none;">Check specific plan guidelines</a>
</div>
        <div class="results" id="results">
            <p class="loading">Select a query above to get started</p>
        </div>
    </div>
<!-- REMOVE this line entirely:
<script src="zoningData.js"></script>
-->

<script>
  // === Helpers ===
function getDefinition(useName) {
  const dict = window.useDefinitions || {};
  if (!useName) return "";

  // exact match first
  if (dict[useName]) return dict[useName];

  // normalize the key
  const normalize = s => String(s)
    .toLowerCase()
    .replace(/\band\b/g, '&')
    .replace(/&/g, 'and')
    .replace(/[\/,‚Äì‚Äî\-]/g, ' ')     // unify separators
    .replace(/\s+/g, ' ')           // collapse spaces
    .trim();

  const normKey = normalize(useName);

  // build a normalized index once per session
  if (!window.__defsIndex) {
    window.__defsIndex = {};
    for (const k of Object.keys(dict)) {
      window.__defsIndex[normalize(k)] = k;
    }
  }

  // find nearest normalized key
  const match = window.__defsIndex[normKey];
  if (match) return dict[match];

  // optional fuzzy fallback: look for partial containment
  for (const [k, v] of Object.entries(dict)) {
    const nk = normalize(k);
    if (nk.includes(normKey) || normKey.includes(nk)) {
      return v;
    }
  }

  return "";
}


  function htmlEscape(s) {
    return String(s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  // === Build dropdowns from window.zoningData (single source of truth) ===
function populateDropdowns() {
  const landUseSelect = document.getElementById('landUseSelect');
  const zoneSelect = document.getElementById('zoneSelect');
  if (!landUseSelect || !zoneSelect) return;

  const data = (window.zoningData && typeof window.zoningData === 'object') ? window.zoningData : {};
  const landUses = Object.keys(data).sort();
  const zones = Array.from(new Set(Object.values(data).flatMap(row => Object.keys(row || {}))))
    .filter(Boolean)
    .sort();

  landUseSelect.innerHTML = '<option value="">Select a land use...</option>';
  zoneSelect.innerHTML = '<option value="">Select a zone...</option>';

  landUses.forEach(use => {
    const opt = document.createElement('option');
    opt.value = use;
    opt.textContent = use;
    landUseSelect.appendChild(opt);
  });
  zones.forEach(zone => {
    const opt = document.createElement('option');
    opt.value = zone;
    opt.textContent = zone;
    zoneSelect.appendChild(opt);
  });
}

function normalizePermission(permission) {
  const p = String(permission || "").toLowerCase().trim();

  // Not permitted / prohibited
  if (!p || /^(np|not\s*permitted|prohibited)\b/.test(p)) return "not-permitted";

  // Conditional bucket (evaluate BEFORE accessory/permitted)
  // Handles: "Minor Use Permit", "MUP", "Use Permit", "CUP", "Conditional"
  if (/\b(mup|minor\W*use\W*permit|use\W*permit|cup|conditional)\b/.test(p)) {
    return "conditional";
  }

  // Accessory bucket
  if (/\b(accessory|acc\.)\b/.test(p) || p.startsWith("a")) return "accessory";

  // Explicit permitted
  if (/\b(permitted|^p$)\b/.test(p)) return "permitted";

  // Fallback = permitted
  return "permitted";
}

function getPermissionClass(permission) {
  return normalizePermission(permission);
}

// === Search: Land Use ===
function searchByLandUse() {
  const selectedUse = document.getElementById('landUseSelect').value;
  const results = document.getElementById('results');

  if (!selectedUse) {
    results.innerHTML = '<p class="no-results">Please select a land use first.</p>';
    return;
  }

  const useData = (window.zoningData || {})[selectedUse];
  if (!useData) {
    results.innerHTML = `<p class="no-results">No data found for "${htmlEscape(selectedUse)}".</p>`;
    return;
  }

  let html = `<h3>Where "${htmlEscape(selectedUse)}" is allowed:</h3>`;

  const def = getDefinition(selectedUse);
  if (def) {
    html += `
      <div class="definition-banner">
        <strong>Definition:</strong> ${htmlEscape(def)}
      </div>`;
  }

  const permitted = [], conditional = [], accessory = [];
  Object.entries(useData).forEach(([zone, permission]) => {
    const item = { zone, permission };
    const kind = normalizePermission(permission);

    if (kind === "not-permitted") return;
    if (kind === "conditional") conditional.push(item);
    else if (kind === "accessory") accessory.push(item);
    else permitted.push(item);
  });

  const byZone = (a, b) => a.zone.localeCompare(b.zone);
  permitted.sort(byZone); conditional.sort(byZone); accessory.sort(byZone);

  if (permitted.length) {
    html += '<h4 class="section-header permitted">Permitted:</h4>';
    permitted.forEach(item => {
      html += `<div class="result-item permitted">
        <span class="zone-name">${htmlEscape(item.zone)}</span>
        <div class="permission-detail">${htmlEscape(item.permission)}</div>
      </div>`;
    });
  }
  if (conditional.length) {
    html += '<h4 class="section-header conditional">Conditional Use Permit Required:</h4>';
    conditional.forEach(item => {
      html += `<div class="result-item conditional">
        <span class="zone-name">${htmlEscape(item.zone)}</span>
        <div class="permission-detail">${htmlEscape(item.permission)}</div>
      </div>`;
    });
  }
  if (accessory.length) {
    html += '<h4 class="section-header accessory">Accessory Use:</h4>';
    accessory.forEach(item => {
      html += `<div class="result-item accessory">
        <span class="zone-name">${htmlEscape(item.zone)}</span>
        <div class="permission-detail">${htmlEscape(item.permission)}</div>
      </div>`;
    });
  }

  if (!permitted.length && !conditional.length && !accessory.length) {
    html += '<p class="no-results">This use is not allowed in any standard zone.</p>';
  }

  results.innerHTML = html;
}

  // === Search: Zone ===
  function searchByZone() {
    const selectedZone = document.getElementById('zoneSelect').value;
    const results = document.getElementById('results');

    if (!selectedZone) {
      results.innerHTML = '<p class="no-results">Please select a zone first.</p>';
      return;
    }

    let html = `<h3>What's allowed in ${htmlEscape(selectedZone)} zoning:</h3>`;
    const permitted = [], conditional = [], accessory = [];

    Object.entries(window.zoningData || {}).forEach(([landUse, zones]) => {
      const permission = zones[selectedZone];
      const kind = normalizePermission(permission);
if (kind !== "not-permitted") {
  const item = { landUse, permission };
  if (kind === "conditional") conditional.push(item);
  else if (kind === "accessory") accessory.push(item);
  else permitted.push(item);
}

    });

    const landUseSpan = (lu) => {
      const def = getDefinition(lu);
      const escLu = htmlEscape(lu);
      const escDef = htmlEscape(def);
      return def
        ? `<span class="zone-name" title="${escDef}" aria-label="${escDef}">${escLu}</span>`
        : `<span class="zone-name">${escLu}</span>`;
    };

    if (permitted.length) {
html += '<h4 class="section-header permitted">Permitted Uses:</h4>';
      permitted.forEach(item => {
        html += `<div class="result-item permitted">
          ${landUseSpan(item.landUse)}
          <div class="permission-detail">${htmlEscape(item.permission)}</div>
        </div>`;
      });
    }
    if (conditional.length) {
html += '<h4 class="section-header conditional">Conditional Use Permit Required:</h4>';
      conditional.forEach(item => {
        html += `<div class="result-item conditional">
          ${landUseSpan(item.landUse)}
          <div class="permission-detail">${htmlEscape(item.permission)}</div>
        </div>`;
      });
    }
    if (accessory.length) {
html += '<h4 class="section-header accessory">Accessory Uses:</h4>';
      accessory.forEach(item => {
        html += `<div class="result-item accessory">
          ${landUseSpan(item.landUse)}
          <div class="permission-detail">${htmlEscape(item.permission)}</div>
        </div>`;
      });
    }

    if (!permitted.length && !conditional.length && !accessory.length) {
      html += '<p class="no-results">No uses are specifically allowed in this zone.</p>';
    }

    results.innerHTML = html;
  }

  // === Init + (optional) auto-react on change ===
  document.addEventListener('DOMContentLoaded', function() {
    populateDropdowns();

    // If you want immediate reaction to dropdown changes:
    document.getElementById('landUseSelect').addEventListener('change', function () {
      document.getElementById('zoneSelect').value = '';
      searchByLandUse();
    });
    document.getElementById('zoneSelect').addEventListener('change', function () {
      document.getElementById('landUseSelect').value = '';
      searchByZone();
    });
  });
</script>

<!-- Minimal map panel (no extra controls) -->
<section id="map-panel" style="border-top:1px solid #e5e7eb;padding:.75rem 0;margin-top:1rem;">
  <div id="viewDiv" style="height:520px;width:100%;border:1px solid #e5e7eb;border-radius:.5rem;"></div>
</section>

<script type="module">
  import WebMap from "https://js.arcgis.com/4.30/@arcgis/core/WebMap.js";
  import MapView from "https://js.arcgis.com/4.30/@arcgis/core/views/MapView.js";
  import Legend from "https://js.arcgis.com/4.30/@arcgis/core/widgets/Legend.js";
  import Search from "https://js.arcgis.com/4.30/@arcgis/core/widgets/Search.js";
  import UniqueValueRenderer from "https://js.arcgis.com/4.30/@arcgis/core/renderers/UniqueValueRenderer.js";

  // ---- Config ----
  const WEBMAP_ID = "fed3b55fe5bf4220b0e74608433eec19";
  const ZONE_FIELD = "Zoning8";
  const APN_FIELD  = "APN";

  // Mirror your existing controls
  const LU_SELECT = document.getElementById("landUseSelect"); // existing
  const ZD_SELECT = document.getElementById("zoneSelect");    // existing

  // Mode (no checkboxes): default to highlight + dim others; honor ?mode=filter if present
  const params = new URLSearchParams(location.search);
  let FILTER_MODE = params.get("mode") === "filter";  // true => filter out; false => dim others
  const EXCLUDED_EFFECT = "grayscale(80%) opacity(35%)";

// Colors aligned to your UI legend
const COLORS = {
  permitted:   [30,126,52,0.4],   // green
  conditional: [176,86,0,0.4],    // orange
  accessory:   [111,66,193,0.35], // purple
  zoneOnly:    [59,130,246,0.30], // blue
  outline:     [48,48,48,1]
};

  const zoningData = window.zoningData || {};
  const normalizePermission = window.normalizePermission || ((p)=>"permitted");

  // Helpers
  const sql = (s) => String(s).replaceAll("'", "''");
  const setParams = (obj) => {
    const u = new URL(location.href);
    Object.entries(obj).forEach(([k,v]) => {
      if (v === null || v === undefined || v === "") u.searchParams.delete(k);
      else u.searchParams.set(k, v);
    });
    history.replaceState({}, "", u.toString());
  };

 function zonesForLandUse(lu) {
  // Build three clean buckets; skip "not permitted"
  const out = { permitted: [], conditional: [], accessory: [] };
  const row = zoningData[lu] || {};

  for (const [zone, perm] of Object.entries(row)) {
    if (!zone) continue;
    const kind = normalizePermission(perm);

    if (kind === "conditional") {
      out.conditional.push(zone);
    } else if (kind === "accessory") {
      out.accessory.push(zone);      // <-- show as its own purple category
    } else if (kind === "not-permitted") {
      // skip entirely (don't highlight/dim)
    } else {
      // "permitted" (and any other fallbacks)
      out.permitted.push(zone);
    }
  }
  return out;


  }

  const uvRendererBuckets = (permitted, conditional, accessory) =>
  new UniqueValueRenderer({
    field: ZONE_FIELD,
    defaultSymbol: {
      type: "simple-fill",
      color: [0, 0, 0, 0],
      outline: { type: "simple-line", color: COLORS.outline, width: 0.25 }
    },
    uniqueValueInfos: [
      ...permitted.map(v => ({
        value: v,
        label: "Permitted",
        symbol: { type: "simple-fill", color: COLORS.permitted,
          outline: { type: "simple-line", color: COLORS.outline, width: 0.5 } }
      })),
      ...conditional.map(v => ({
        value: v,
        label: "Conditional Use Permit",
        symbol: { type: "simple-fill", color: COLORS.conditional,
          outline: { type: "simple-line", color: COLORS.outline, width: 0.5 } }
      })),
      ...accessory.map(v => ({
        value: v,
        label: "Accessory Use",
        symbol: { type: "simple-fill", color: COLORS.accessory,
          outline: { type: "simple-line", color: COLORS.outline, width: 0.5 } }
      }))
    
    ]
  });

  const uvRendererZoneOnly = (zone) => new UniqueValueRenderer({
    field: ZONE_FIELD,
    uniqueValueInfos: [{
      value: zone,
      label: zone,
      symbol:{ type:"simple-fill", color:COLORS.zoneOnly, outline:{ type:"simple-line", color:COLORS.outline, width:.75 } }
    }],
    defaultSymbol: { type:"simple-fill", color:[0,0,0,0] }
  });

  // Map init
  const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });
  const view = new MapView({ map: webmap, container: "viewDiv", constraints:{ snapToZoom:false }});
  view.ui.add(new Search({ view }), "top-right");
  view.ui.add(new Legend({ view }), "bottom-right");

  let layer, layerView;

  const zoomWhere = async (w) => {
    const { extent } = await layer.queryExtent({ where: w });
    if (extent) await view.goTo({ target: extent.expand(1.1) }, { duration: 500 }).catch(()=>{});
  };

  async function applyLUFromMain() {
    const lu = LU_SELECT?.value || "";
    // clear 'zd' when LU is active
    setParams({ lu, zd: null, mode: FILTER_MODE ? "filter" : "highlight" });
    if (!lu) { layer.renderer=null; layerView.filter=null; layer.definitionExpression=""; return; }

    const sets = zonesForLandUse(lu);
const all = [...new Set([
  ...sets.permitted,
  ...sets.conditional,
  ...sets.accessory      // include accessory

])];

    const where = all.length ? `${ZONE_FIELD} IN (${all.map(v=>`'${sql(v)}'`).join(",")})` : "1=0";

    if (FILTER_MODE) {
      layer.definitionExpression = all.length ? where : "";
      layerView.filter = null; layerView.effect = null;
    } else {
      layer.definitionExpression = "";
      layerView.filter = all.length ? { where } : null;
      layerView.effect = layerView.filter ? { filter: layerView.filter, excludedEffect: EXCLUDED_EFFECT } : null;
    }
layer.renderer = uvRendererBuckets(
  sets.permitted,
  sets.conditional,
  sets.accessory,         // include accessory
 
);

    if (all.length) await zoomWhere(where);
  }

  async function applyZDFromMain() {
    const zd = ZD_SELECT?.value || "";
    // clear 'lu' when ZD is active
    setParams({ zd, lu: null, mode: FILTER_MODE ? "filter" : "highlight" });
    if (!zd) { layer.renderer=null; layerView.filter=null; layer.definitionExpression=""; return; }

    const where = `${ZONE_FIELD}='${sql(zd)}'`;
    if (FILTER_MODE) {
      layer.definitionExpression = where; layerView.filter=null; layerView.effect=null;
    } else {
      layer.definitionExpression = ""; layerView.filter = { where };
      layerView.effect = { filter: { where }, excludedEffect: EXCLUDED_EFFECT };
    }
    layer.renderer = uvRendererZoneOnly(zd);
    await zoomWhere(where);
  }

  // Click ‚Üí ?apn= + popup
  view.on("click", async (event) => {
    if (!layer) return;
    const hit = await view.hitTest(event, { include: [layer] });
    const g = hit?.results?.[0]?.graphic;
    if (!g) return;
    const apnVal = g.attributes?.[APN_FIELD];
    if (apnVal != null && apnVal !== "") setParams({ apn: String(apnVal) });
    view.popup.open({ features: [g], location: event.mapPoint });
  });

  // Restore ?apn=
  async function restoreAPNFromURL() {
    const apn = new URLSearchParams(location.search).get("apn");
    if (!apn) return;
    const q = layer.createQuery();
    q.where = `${APN_FIELD}='${sql(apn)}'`;
    q.returnGeometry = true; q.outFields = ["*"];
    const res = await layer.queryFeatures(q);
    if (res.features.length) {
      const f = res.features[0];
      await view.goTo({ target: f.geometry.extent?.expand(1.2) || f.geometry }, { duration: 500 }).catch(()=>{});
      view.popup.open({ features: [f], location: f.geometry.centroid || f.geometry.extent?.center });
    }
  }

// Boot
view.when(async () => {
  try {
    // Ensure the webmap & all layers are loaded before we search them
    await webmap.when();
    // loadAll() awaits nested GroupLayers/MapImage sublayers, etc.
    if (typeof webmap.loadAll === "function") {
      await webmap.loadAll();
    }

    // Resolve a proper FeatureLayer with Zoning8 (search ALL layers, including sublayers)
    async function resolveTargetLayer() {
      const all = webmap.allLayers.toArray(); // flattens group/sublayers
      for (const lyr of all) {
        try {
          if (lyr.type !== "feature") continue; // need FeatureLayer for layerView.effect
          if (typeof lyr.load === "function") await lyr.load();
          const fields = (lyr.fields || []).map(f => (f.name || "").toLowerCase());
          if (fields.includes(ZONE_FIELD.toLowerCase())) return lyr;
        } catch (e) {
          console.warn("[Map] Skip layer due to load error:", lyr?.title || lyr?.id, e);
        }
      }
      return null;
    }

    layer = await resolveTargetLayer();

    if (!layer) {
      console.error("[Map] No FeatureLayer with field", ZONE_FIELD, "found in webmap", WEBMAP_ID);
      // Optional: show a friendly placeholder in the map div
      const el = document.getElementById("viewDiv");
      if (el) el.innerHTML = "<div style='padding:12px;color:#b00'>Map layer with field <b>"
          + ZONE_FIELD + "</b> not found. Check the AGOL webmap and field name.</div>";
      return;
    }

    layerView = await view.whenLayerView(layer);

    // Check highlight/dim support; if not, safely fall back to filter mode
    const SUPPORTS_EFFECT = ("effect" in layerView) && ("filter" in layerView);
    if (!SUPPORTS_EFFECT && !FILTER_MODE) {
      console.warn("[Map] FeatureEffect not supported; switching to filter mode.");
      FILTER_MODE = true;
    }

    console.log("[Map] Using layer:", layer.title || layer.id,
                "| supports effect:", SUPPORTS_EFFECT,
                "| mode:", FILTER_MODE ? "filter" : "highlight");

    // Wire to main selectors
    LU_SELECT?.addEventListener("change", applyLUFromMain);
    ZD_SELECT?.addEventListener("change", applyZDFromMain);

    // Initial restore from URL / main UI
    const p = new URLSearchParams(location.search);
    if (p.get("mode")==="filter") FILTER_MODE = true; // honor URL
    if (p.get("zd")) {
      ZD_SELECT && (ZD_SELECT.value = p.get("zd"));
      await applyZDFromMain();
    } else if (p.get("lu")) {
      LU_SELECT && (LU_SELECT.value = p.get("lu"));
      await applyLUFromMain();
    }

    await restoreAPNFromURL();

  } catch (err) {
    console.error("[Map] Fatal init error:", err);
    const el = document.getElementById("viewDiv");
    if (el) el.innerHTML = "<div style='padding:12px;color:#b00'>Map failed to load. See console for details.</div>";
  }
});

</script>


<style>
  /* simple split view */
  body.split-on #main, body.split-on #map-panel { /* adjust #main to your results wrapper if needed */
    display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;
  }
  @media (max-width:900px){
    body.split-on #main, body.split-on #map-panel { grid-template-columns:1fr; }
  }
</style>

</body>
</html>
